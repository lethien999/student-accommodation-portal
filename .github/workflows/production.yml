# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Production CI/CD

permissions:
    contents: read
    packages: read
    security-events: write

on:
    push:
        branches: [main]
        tags:
            - "v*"
    pull_request:
        branches: [main]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME_BACKEND: ${{ github.repository }}/backend
    IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend

jobs:
    # Run tests first
    test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:14
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: student_accommodation_test
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 5432:5432

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: |
                      server/package-lock.json
                      client/package-lock.json

            - name: Install Backend Dependencies
              working-directory: ./server
              run: npm ci --legacy-peer-deps

            - name: Install Frontend Dependencies
              working-directory: ./client
              run: npm ci --legacy-peer-deps

            - name: Run Backend Tests
              working-directory: ./server
              run: npm test || echo "Tests not configured yet"
              env:
                  NODE_ENV: test
                  DB_HOST: localhost
                  DB_PORT: 5432
                  DB_NAME: student_accommodation_test
                  DB_USER: postgres
                  DB_PASSWORD: postgres
                  JWT_SECRET: test-secret-key

            - name: Run Frontend Tests
              working-directory: ./client
              run: npm test -- --passWithNoTests
              env:
                  CI: true

            - name: Build Frontend
              working-directory: ./client
              run: npm run build
              env:
                  REACT_APP_API_URL: http://localhost:5000/api

    # Build and push Docker images
    build-and-push:
        needs: test
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        permissions:
            contents: read
            packages: write

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Backend
              id: meta-backend
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix={{branch}}-

            - name: Build and push Backend image
              uses: docker/build-push-action@v5
              with:
                  context: ./server
                  push: true
                  tags: ${{ steps.meta-backend.outputs.tags }}
                  labels: ${{ steps.meta-backend.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Extract metadata for Frontend
              id: meta-frontend
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix={{branch}}-

            - name: Build and push Frontend image
              uses: docker/build-push-action@v5
              with:
                  context: ./client
                  push: true
                  tags: ${{ steps.meta-frontend.outputs.tags }}
                  labels: ${{ steps.meta-frontend.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
                  build-args: |
                      REACT_APP_API_URL=${{ secrets['REACT_APP_API_URL'] || 'http://localhost:5000/api' }}

    # Security scanning
    security-scan:
        needs: build-and-push
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        steps:
            - uses: actions/checkout@v4

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Run Trivy vulnerability scanner - Backend
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main
                  format: "sarif"
                  output: "trivy-backend-results.sarif"

            - name: Run Trivy vulnerability scanner - Frontend
              uses: aquasecurity/trivy-action@master
              with:
                  image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main
                  format: "sarif"
                  output: "trivy-frontend-results.sarif"

            - name: Upload Trivy Backend SARIF
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: "trivy-backend-results.sarif"
                  category: backend

            - name: Upload Trivy Frontend SARIF
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: "trivy-frontend-results.sarif"
                  category: frontend

    # Deploy to production (example using SSH)
    deploy:
        needs: [build-and-push, security-scan]
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'

        environment: "production"
        continue-on-error: true

        steps:
            - uses: actions/checkout@v4

            - name: Deploy to Production Server
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: ${{ secrets['PROD_HOST'] }}
                  username: ${{ secrets['PROD_USER'] }}
                  key: ${{ secrets['PROD_SSH_KEY'] }}
                  port: ${{ secrets['PROD_PORT'] || 22 }}
                  script: |
                      cd /opt/student-accommodation-portal

                      # Pull latest code
                      git pull origin main

                      # Pull latest Docker images
                      docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }}
                      docker-compose -f docker-compose.prod.yml pull

                      # Restart services with zero downtime
                      docker-compose -f docker-compose.prod.yml up -d --remove-orphans

                      # Clean up old images
                      docker image prune -af

                      echo "Deployment completed successfully!"

    # Notify on deployment
    notify:
        needs: deploy
        runs-on: ubuntu-latest
        if: always()
        env:
            SLACK_WEBHOOK_URL: ${{ secrets['SLACK_WEBHOOK_URL'] }}

        steps:
            - name: Send Slack notification
              if: env.SLACK_WEBHOOK_URL != ''
              uses: slackapi/slack-github-action@v1.25.0
              with:
                  payload: |
                      {
                        "text": "Deployment to production: ${{ job.status }}\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}"
                      }
