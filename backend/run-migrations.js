/**
 * Run migrations for new tables
 */
require('dotenv').config();
const sequelize = require('./config/database');

const runMigrations = async () => {
    try {
        console.log('Connecting to database...');
        await sequelize.authenticate();
        console.log('✅ Database connected');

        // Check if propertyId column exists in accommodations
        console.log('Checking accommodations table...');
        const [columns] = await sequelize.query("SHOW COLUMNS FROM accommodations LIKE 'propertyId'");

        if (columns.length === 0) {
            console.log('Adding propertyId column to accommodations...');
            await sequelize.query(`
        ALTER TABLE accommodations 
        ADD COLUMN propertyId INT NULL,
        ADD FOREIGN KEY (propertyId) REFERENCES properties(id) ON DELETE SET NULL ON UPDATE CASCADE
      `);
            console.log('✅ Added propertyId to accommodations');
        } else {
            console.log('✅ propertyId already exists in accommodations');
        }

        // Check if rent_billings table exists
        const [tables] = await sequelize.query("SHOW TABLES LIKE 'rent_billings'");

        if (tables.length === 0) {
            console.log('Creating rent_billings table...');
            await sequelize.query(`
        CREATE TABLE rent_billings (
          id INT AUTO_INCREMENT PRIMARY KEY,
          accommodationId INT NOT NULL,
          tenantId INT NOT NULL,
          landlordId INT NOT NULL,
          propertyId INT NULL,
          contractId INT NULL,
          billingMonth INT NOT NULL,
          billingYear INT NOT NULL,
          billingPeriod VARCHAR(7) NOT NULL,
          dueDate DATETIME NOT NULL,
          roomRent DECIMAL(12,2) DEFAULT 0,
          electricityPreviousReading DECIMAL(10,2) DEFAULT 0,
          electricityCurrentReading DECIMAL(10,2) DEFAULT 0,
          electricityUsage DECIMAL(10,2) DEFAULT 0,
          electricityPrice DECIMAL(10,2) DEFAULT 3500,
          electricityAmount DECIMAL(12,2) DEFAULT 0,
          waterPreviousReading DECIMAL(10,2) DEFAULT 0,
          waterCurrentReading DECIMAL(10,2) DEFAULT 0,
          waterUsage DECIMAL(10,2) DEFAULT 0,
          waterPrice DECIMAL(10,2) DEFAULT 15000,
          waterAmount DECIMAL(12,2) DEFAULT 0,
          internetFee DECIMAL(12,2) DEFAULT 0,
          garbageFee DECIMAL(12,2) DEFAULT 0,
          parkingFee DECIMAL(12,2) DEFAULT 0,
          otherFees DECIMAL(12,2) DEFAULT 0,
          otherFeesDescription VARCHAR(500),
          discount DECIMAL(12,2) DEFAULT 0,
          discountReason VARCHAR(255),
          subtotal DECIMAL(12,2) DEFAULT 0,
          totalAmount DECIMAL(12,2) DEFAULT 0,
          previousBalance DECIMAL(12,2) DEFAULT 0,
          grandTotal DECIMAL(12,2) DEFAULT 0,
          paidAmount DECIMAL(12,2) DEFAULT 0,
          remainingBalance DECIMAL(12,2) DEFAULT 0,
          status ENUM('draft','pending','partial','paid','overdue','cancelled') DEFAULT 'draft',
          paidAt DATETIME NULL,
          notificationSent BOOLEAN DEFAULT FALSE,
          notificationSentAt DATETIME NULL,
          reminderCount INT DEFAULT 0,
          lastReminderAt DATETIME NULL,
          notes TEXT,
          isAutoGenerated BOOLEAN DEFAULT FALSE,
          createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
          updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
          FOREIGN KEY (accommodationId) REFERENCES accommodations(id),
          FOREIGN KEY (tenantId) REFERENCES users(id),
          FOREIGN KEY (landlordId) REFERENCES users(id),
          UNIQUE KEY unique_billing (accommodationId, billingPeriod),
          INDEX idx_tenant (tenantId),
          INDEX idx_landlord (landlordId),
          INDEX idx_status (status),
          INDEX idx_due_date (dueDate)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
      `);
            console.log('✅ Created rent_billings table');
        } else {
            console.log('✅ rent_billings table already exists');
        }

        console.log('\n✅ All migrations completed successfully!');
        process.exit(0);
    } catch (error) {
        console.error('❌ Migration error:', error.message);
        process.exit(1);
    }
};

runMigrations();
